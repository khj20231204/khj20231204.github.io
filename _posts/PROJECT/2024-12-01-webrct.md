---
layout: single
title: webRCT
categories: PROJECT
tag: []
---

1. # webRCT
   내가 방을 만들든, 내가 다른 방에 참여하든 자신의 브라우저는 자신의 방에서 Publisher.   
   방장 입장에서 나는 subscribe.

1. # 메서드
   ```javascript

      var sfutest = null;

      Janus.init({debug: "all", callback: function() { //야누스 서버 초기화
		
			janus = new Janus( //야누스 객체 생성
         {
            server: server,
            success: function() {
               janus.attach( //야누스 서버에 접속
                  {
                     plugin: "janus.plugin.videoroom",
                     opaqueId: opaqueId,
                     success: function(pluginHandle) { //접속 성공이면 success 반환
                        sfutest = pluginHandle; //sfutest가 webRTC 연결 객체
                        ...
                     }  ,
                     webrtcState: function(on) {
                        ...
                     }, 
                     onmessage: function(msg, jsep) {
                        ...
                     },  
                     onlocalstream: function(stream) {
                        ...
                     },
                     onremotestream: function(stream) {
                        ...
                     },
                     oncleanup: function() {
                        ...
                     }
                  });
               },
            })
         }
      })
   ```
   webrtcState,onmessage,onlocalstream,onremotestream,oncleanup

   다음과 같은 메소드들은 야누스 서버로부터 이벤트가 발생했을 경우 받게 되는 함수들입니다.   

   ```yml
      success -> 
      registerUsername()   
      {   
         display : "user"
         ptype : "publisher"
         request : "join"
         room : 88556
      }

      # 기존 참가자가 없는 경우
      -> onmessage : msg
      {
         description : "test"
         id : 7475349030294197
         private_id : 2799667236
         publishers : Array(0)
         length : 0
         [[Prototype]] : Array(0)
         room : 88556
         videoroom : "joined"
         [[Prototype]] : Object
      }

      # 참가자가 있는 경우
      -> onmessage : msg
      {
         description : "test"
         id : 7475349030294197 # 내 id
         private_id : 2799667236
         publishers : Array(1)
            0 : {id: 5437609289359478 , display: 'Xhhf', audio_codec: 'opus', video_codec: 'vp8', streams: Array(2), …}  
            # 5437609289359478 기존 참가자 id
               length : 1  
            [[Prototype]] : Array(0)
         room : 88556
         videoroom : "joined"
         [[Prototype]] : Object
      }
      -> newRemoteFeed() : 새로운 유저 들어왔을 때 
      -> onlocalstream : stream
      {
         active : true
         id : "775e7f12-d43b-4c16-9caf-91bee25f8e1c"
         onactive : null
         onaddtrack : null
         oninactive : null
         onremovetrack : null
      }
      -> onmessage : msg   
      {
         audio_codec : "opus"
         configured : "ok"
         room : 88556
         streams : Array(2)
            0 : {type: 'audio', mindex: 0, mid: '0', codec: 'opus', opus-fec: true}
            1 : {type: 'video', mindex: 1, mid: '1', codec: 'vp8'}
         length : 2
         [[Prototype]] : Array(0)
         video_codec : "vp8"
         videoroom : "event"
      }
   ```
   위에 함수 중에서 가장 주의 깊게 봐야할 함수는 onmessage함수입니다. onmessage함수는 데이터 채널(DataChannel)을 통해 수신된 메시지를 처리하는 이벤트 핸들러입니다. sfutest.send 이후에 호출되는 콜백 함수입니다. WebRTC는 음성, 비디오뿐만 아니라 데이터를 실시간으로 전송할 수 있는 기능을 제공하며, 데이터 채널은 주로 텍스트, 파일, 바이너리 데이터 전송에 사용됩니다. 전송하는 주체, 전송받는 주체에 이벤트가 발생하면 호출되는 콜백함수입니다. 따라서 다른 함수들에 비해 사용 빈도가 높습니다. 누군가 회의에 참석하거나 나가는 경우, 다른 이벤트가 발생하는 경우에 실행되는 함수가 onmessage입니다.   

1. # Publisher 와 Subscriber
   내가 송출하는 경우 나는 Publisher   
   내가 수신하는 경우 나는 Subscriber   

   1. ## 단방향(교육, 아프리카TV)   
      방장 : Publisher   
      참가자 : Subscriber   

   1. ## 양방향(회의)   
      방장 : Publisher 이면서 Subscriber   
      참가자 : Publisher 이면서 Subscriber

1. # Publisher와 Subscriber를 결정짓는 핵심 소스

   offer생성
   ```javascript
      - publishOwnFeed() -

      sfutest.createOffer( //
		{
			/*
			//오디오 비디오 수신 : audioRecv, videoRecv
			//오디오 비디오 송신 : audioSend, videoSend
			WebRTC 피어 단계 - 브라우저 간의 WebRTC 설정 단계, 현재 subscribe 구독자 브라우저기 때문에 
			수신은 true, 송신은 false
			*/
			media: { audioRecv: true, videoRecv: true, audioSend: false, videoSend: false },	// subscriber
         media: { audioRecv: false, videoRecv: false, audioSend: true, videoSend: true },	// publisher
			
			simulcast: doSimulcast,
			simulcast2: doSimulcast2,
			success: function(jsep) {
				Janus.debug("Got publisher SDP!", jsep);
				/*
				클라이언트가 야누스 서버 플러그인에 대한 오디오, 비디오 설정을 보낸다

				VideoRoom 플러그인의 주요 요청 명령어는 다음과 같습니다:

				join: 방에 참가.
				publish: 자신의 스트림을 방에 송출.
				subscribe: 특정 스트림을 구독.
				configure: 미디어 트랙 구성 변경.
				leave: 방을 떠남.
            */
				
            //publisher로 서버에 offer전달
				var publish = { request: "configure", audio: true, video: true };
				sfutest.send({ message: publish });
				
            //subscriber로 서버에 offer전달
				var subscribe = { request: "subscribe", streams: [{ feed: parseInt(방번호) }] };
				//streams: [{ feed: 1234, mid: "video" }] 특정 미디어 video만 수신
				sfutest.send({ message: subscribe });
			}
      }
   ```

   방 생성   
   ```javascript
      - registerUsername() -

      var createRoom = {
         request : "create",
         room : myroom,
         permanent : false,
         record: false,
         publishers: 6,
         bitrate : 128000,
         fir_freq : 10,
         //ptype: "publisher",
         ptype: "publisher",
         description: "test",
         is_private: false
      }

      sfutest.send({ message: createRoom, success:function(result){ ... }})
   ```

   Publisher로 방 참가
   ```javascript
      - registerUsername() -

      var joinRequest = {
      request: "join",
      room: 1234, // 방 ID
      ptype: "publisher", // Publisher로 참가
      display: "Publisher Name" // 표시 이름
      };
      sfutest.send({ message: joinRequest });
   ```

   Subscriber로 바로 방 참가
   ```javascript
      - registerUsername() -

      var joinRequest = {
      request: "join",
      room: 1234, // 동일한 방 ID
      ptype: "subscriber", // Subscriber로 참가
      };
      sfutest.send({ message: joinRequest });
   ```

1. # 메소드 

   1. ## newRemoteFeed() : 새로운 유저가 들어왔을 때   

      1. 단뱡향 : A방에 B가 입장   
      captin이란 방장이 이미 A방에 있는 경우 : B란 참가자가 들어왔다 -> 이때, B의 입장에 새로운 유저란 captin 방장이 된다.   

      1. 양방향 : A방에 B가 입장   
      captin입장에서 새로운 유저란 B.   
      B입장에서 새로운 유저란 captin   

   1. ## publishOwnFeed() : 화면 설정   
      1.WebRTC와 브라우저간의 수신, 송신 설정   
      2.야누스 서버 플로그인과 클라이언트의 수신, 송신 설정   
      => 위에 2개가 일치해야 한다   

   1. ## registerUsername() : 방을 만들거나 조인   
      사용자를 webRCT에 등록   
      방을 만들 수 있고, 다른 방을 참관할 수 있는 subscriber설정   