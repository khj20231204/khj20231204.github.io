---
layout: single
title: XMLíŒŒì¼ì„ JSONìœ¼ë¡œ íŒŒì‹±í•˜ê¸°
categories: PROJECT
tag: []
---

1. # ëŒ€ìš©ëŸ‰ api
   <a href="https://safemap.go.kr/opna/data/dataView.do?objtId=127">https://safemap.go.kr/opna/data/dataView.do?objtId=127</a>   
   ì „êµ­ ì•½êµ­ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ëŠ”ë° ë°ì´í„° ê±´ ìˆ˜ê°€ 25ë§Œê°œ ì…ë‹ˆë‹¤.   

1. # pageNoì™€ numOfRows êµ¬ì„±
   http://safemap.go.kr/openApiService/data/getPharmacyData.do?serviceKey=${process.env.REACT_APP_PHAMARCY_API_KEY}&pageNo=1&numOfRows=1000&type=JSON

   í•´ë‹¹ apiì˜ ì£¼ì†Œë¡œ pageNoì™€ numOfRowsë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.   

   ì´ë•Œ í˜ì´ì§€ ê°’ê³¼ rowê°’ì„ ì–´ë–»ê²Œ ì„¤ì •í•˜ëŠëƒì— ë”°ë¼ ê°€ì ¸ì˜¤ëŠ” ê°’ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.   

   page=1, row=1000 : ì‹œì‘ numê°’ 1   
   page=2, row=1000 : ì‹œì‘ numê°’ 1001   
   page=3, row=1000 : ì‹œì‘ numê°’ 2001   
   ...   

   ë˜ëŠ”   

   page=1, row=2000 : ì‹œì‘ numê°’ 1   
   page=2, row=2000 : ì‹œì‘ numê°’ 2001   
   page=3, row=2000 : ì‹œì‘ numê°’ 4001   
   ...
   page=12, row=2000 : ì‹œì‘ numê°’ 22001 ~ ë§ˆì§€ë§‰ num ê°’ 24000

   totalCount => 24000ê°œ   


1. # itemìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°

   ```javascript
           
      let testUrl = encodeURI(`http://safemap.go.kr/openApiService/data/getPharmacyData.do?serviceKey=AH80S7N7P3&pageNo=2&numOfRows=300&type=JSON`);
      let response = await api.get(testUrl);

      console.log(response) 
      //ê²°ê³¼ ê°’ : {data: '<?xml version="1.0" encoding="UTF-8"?><response><hâ€¦totalCount>24474</totalCount>\n</body>\n</response>', status: 200, statusText: 'OK', headers: AxiosHeaders, config: {â€¦},Â â€¦}
   ```
   encodeURI :  ì£¼ì†Œì— ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ìë¥¼ urlí˜•íƒœë¡œ ë³€í˜•í•´ ì¤ë‹ˆë‹¤.   

   responseì˜ ê²°ê³¼ê°’ìœ¼ë¡œ data, status, statusText, headers, config ,... ë“±ì´ ìˆìŠµë‹ˆë‹¤.   
   ìš°ë¦¬ê°€ í•„ìš”í•œ ê²ƒì€ dataì™€ statusì…ë‹ˆë‹¤. statusë¥¼ í†µí•´ ifë¬¸ìœ¼ë¡œ ì •ìƒì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°›ì•„ì™”ëŠ”ì§€, ì˜¤ë¥˜ê°€ ìˆì—ˆëŠ”ì§€ì˜ ì¡°ê±´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. statusê°€ 200ì´ë©´ ì •ìƒì…ë‹ˆë‹¤.   
   xmlí˜•ì‹ì´ë€ data ì „ì²´ë¥¼ ì–˜ê¸°í•©ë‹ˆë‹¤. xmlí˜•íƒœ ì „ì²´ `<?xml version="1.0" encoding="UTF-8"?>` ì´ ë¶€ë¶„ì´ í¬í•¨ëœ ì „ì²´ë¥¼ jsoní˜•íƒœë¡œ ë³€í˜• ì‹œì¼œì•¼ ì œëŒ€ë¡œ ì¸ì‹ì„ í•©ë‹ˆë‹¤.   

1. # xml -> json
   ```javascript
      let testUrl = encodeURI(`http://safemap.go.kr/openApiService/data/getPharmacyData.do?serviceKey=${process.env.REACT_APP_PHAMARCY_API_KEY}&pageNo=3&numOfRows=2000&type=JSON`);

      let response = await api.get(testUrl);
      const jsonResult = convert.xml2json(response.data, {compact:true, spaces:3}); //xml -> json
      let data = JSON.parse(jsonResult); //json -> ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´
   ```

      1. ì„¸ë¶€ ë‚´ìš©ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°   

   ```javascript
      let testUrl = encodeURI(`http://safemap.go.kr/openApiService/data/getPharmacyData.do?serviceKey=AH80S7N7-AH80-AH80-AH80-AH80S7N7P3&pageNo=1&numOfRows=40&type=JSON`);
      let response = await api.get(testUrl.toString());
   ```
   data -> request -> responseXML -> all   

   <img src="../../imgs/project/pharm_api_1.png" style="border:3px solid black;border-radius:9px;width:600px">   
   6:item ~ 37:DUTYWEEKENDAT ê¹Œì§€ê°€ í•˜ë‚˜ì˜ ì•½êµ­ ì •ë³´ì…ë‹ˆë‹¤. 
   ê·¸ë¦¬ê³    
   38:item ~ 69:DUTYWEEKENDAT ê¹Œì§€ê°€ ë˜ í•˜ë‚˜ì˜ ì•½êµ­ ì •ë³´ì…ë‹ˆë‹¤.   

   6~37, 38~69, 70~101, ... 31ê°œ ë°ì´í„° ë‹¨ìœ„ë¡œ ë‹¤ìŒ ì•½êµ­ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. 

   ì´ rowê°’ì€ 8110ë²ˆê¹Œì§€ë¡œ 25,9529ê°œì˜ rowê°’ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.   

   ì „ì²´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ë„ˆë¬´ ë§ì€ delayê°€ ë°œìƒí•´ì„œ ì–´ë–»ê²Œ í• ê¹Œ ìƒê° ì¤‘ xmlíŒŒì¼ì„ dbì— ë„£ëŠ” ê²ƒì„ gptê°€ ì•Œë ¤ì£¼ì—ˆìŠµë‹ˆë‹¤.ğŸ‘Œ   

1. # xml2js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©

   xmlíŒŒì¼ì˜ ê°’ì„ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ì„œëŠ” jsonìœ¼ë¡œ ë³€ê²½ì„ í•´ì•¼í•©ë‹ˆë‹¤.   

   xml2js ì„¤ì¹˜   
   ```javascript
      npm install axios xml2js
   ```   

   xml2js ì‚¬ìš©   
   ```javascript

      const fetchData = async () => {

         try{
            let obj = new Object();
            let array = new Array();

            let testUrl = encodeURI(`http://safemap.go.kr/openApiService/data/getPharmacyData.do?serviceKey=${process.env.REACT_APP_PHAMARCY_API_KEY}&pageNo=${page}&numOfRows=2000&type=JSON`);
            let response = await api.get(testUrl);
            //console.log(response);
            const jsonResult = convert.xml2json(response.data, {compact:true, spaces:3}); // Compact : JSONìœ¼ë¡œ ë°›ê¸°, spaces : ë“¤ì—¬ì“°ê¸°
            let data = JSON.parse(jsonResult); //api ë°ì´í„°ë¥¼ jsonìœ¼ë¡œ ë°›ìŒ
            
            let itemData = data.response.body.items;

            for(var i=0 ; i<itemData.item.length ; i++) 
               array.push(itemData.item[i]);
            
            await mapapi.savePharmDatas(array);  

         }catch(error){
            console.log(error);
         }
      }
   ```   

   Map<String, Object>ë¡œ ë°›ì•˜ë‹¤. mapì˜ valueê°’ì— numì´ intì´ê¸° ë•Œë¬¸ì— í•¨ìˆ˜ë¡œ ê°’ì„ ë°›ì„ ë•Œ ì œë„¤ë¦­ì„ ì‚¬ìš©
   ì œë„¤ë¦­ìœ¼ë¡œ ë¦¬í„´ì„ í•˜ë©´ Objectì˜ ê²°ê³¼ê°’ìœ¼ë¡œ ê·¸ëƒ¥ ë°›ëŠ”ë‹¤.   
   
   DTOë¥¼ ì‚¬ìš©í•´ì„œ ë°›ìœ¼ë ¤ê³  í–ˆëŠ”ë° ë³´ë‚´ëŠ” ìª½ì—ì„œ ë¬¸ìì—´ì„ ì˜ë¼ì¤˜ì•¼ í•œë‹¤.    
   ì§€ê¸ˆ ë°›ëŠ” ë°ì´í„°ê°€   
   {NUM={_text=1}, DUTYADDR={_text=ëŒ€ì „ê´‘ì—­ì‹œ ë™êµ¬ ê³„ì¡±ë¡œ 362, ì„±ë‚¨ì•½êµ­ 1ì¸µ (ì„±ë‚¨ë™)}, DUTYETC={_text=null},  DUTYWEEKENDAT={_text=N}}    
   {NUM={_text=2}, DUTYADDR={_text=ê²½ê¸°ë„ í™”ì„±ì‹œ ë™íƒ„ì‹ ë¦¬ì²œë¡œ1ê¸¸ 73, 103í˜¸ (ì‚°ì²™ë™)}, ...
   ì´ëŸ° í˜•íƒœ.   
   {_text ì—†ì• ê³  ê°€ì¥ ë§ˆì§€ë§‰ } ë„ ì—†ì• ì•¼í•œë‹¤. í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ ë¬¸ìì—´ì„ ì˜ë¼ì„œ ì œëŒ€ë¡œ ì‘ì„±ëœ jsoníŒŒì¼ì„ ë³´ë‚´ë©´
   ì„œë²„ìª½ì—ì„œ List<Pharm>ìœ¼ë¡œ DTOë¡œ ë°›ì„ ìˆ˜ ìˆë‹¤.   
   ì´ë¯¸ mapper ìª½ì— foreachë¬¸ìœ¼ë¡œ Mapìœ¼ë¡œ ì‘ì—…ì„ í•´ë‘¬ì„œ Map<String, Object>ë¡œ ë°›ëŠ”ë‹¤   
   ```java
      @PostMapping("/savePharmDatas")
      public  ResponseEntity<String> savePharmDatas(@RequestBody List<Map<String,Object>> pharmData) {

         //mapì˜ valueê°’ ìë¥´ê¸°
         for(int i=0 ; i<pharmData.size() ; i++){
            Map<String, Object> map = pharmData.get(i);

            map.put("NUM", splitMap(map.get("NUM"),"NUM"));
            map.put("DUTYADDR", splitMap(map.get("DUTYADDR"),""));
            map.put("DUTYNAME", splitMap(map.get("DUTYNAME"),""));
            map.put("DUTYTEL1", splitMap(map.get("DUTYTEL1"),""));
            map.put("DUTYTIME1C", splitMap(map.get("DUTYTIME1C"),""));
            map.put("DUTYTIME2C", splitMap(map.get("DUTYTIME2C"),""));
            map.put("DUTYTIME3C", splitMap(map.get("DUTYTIME3C"),""));
            map.put("DUTYTIME4C", splitMap(map.get("DUTYTIME4C"),""));
            map.put("DUTYTIME5C", splitMap(map.get("DUTYTIME5C"),""));
            map.put("DUTYTIME6C", splitMap(map.get("DUTYTIME6C"),""));
            map.put("DUTYTIME7C", splitMap(map.get("DUTYTIME7C"),""));
            map.put("DUTYTIME8C", splitMap(map.get("DUTYTIME8C"),""));
            map.put("DUTYTIME1S", splitMap(map.get("DUTYTIME1S"),""));
            map.put("DUTYTIME2S", splitMap(map.get("DUTYTIME2S"),""));
            map.put("DUTYTIME3S", splitMap(map.get("DUTYTIME3S"),""));
            map.put("DUTYTIME4S", splitMap(map.get("DUTYTIME4S"),""));
            map.put("DUTYTIME5S", splitMap(map.get("DUTYTIME5S"),""));
            map.put("DUTYTIME6S", splitMap(map.get("DUTYTIME6S"),""));
            map.put("DUTYTIME7S", splitMap(map.get("DUTYTIME7S"),""));
            map.put("DUTYTIME8S", splitMap(map.get("DUTYTIME8S"),""));
            map.put("HPID", splitMap(map.get("HPID"),""));
            map.put("POSTCDN1", splitMap(map.get("POSTCDN1"),""));
            map.put("POSTCDN2", splitMap(map.get("POSTCDN2"),""));
            map.put("LON", splitMap(map.get("LON"),""));
            map.put("LAT", splitMap(map.get("LAT"),""));
            map.put("X", splitMap(map.get("X"),""));
            map.put("Y", splitMap(map.get("Y"),""));
            map.put("DUTYWEEKENDAT", splitMap(map.get("DUTYWEEKENDAT"),""));
         }

         int result = phamarcyService.savePharmDatas(pharmData);
         //int result = examService.saveData(pharmData);

      return new ResponseEntity<>("OK", HttpStatus.OK);
      }

      //numì€ intí˜•ì´ê¸° ë•Œë¬¸ì— ì œë„¤ë¦­ìœ¼ë¡œ ë°˜í™˜
      <T> T splitMap(Object obj, String key){

         String str = String.valueOf(obj);
         str = str.substring(7, str.length());
         str = str.substring(0, str.length()-1);

         if(key.equals("NUM"))
            return (T)Integer.valueOf(str);

         return (T)str;
      }
   ```

1. # JSONê³¼ DTO

   `List<Pharm>` : DTOë¥¼ ë§Œë“¤ì—ˆì„ ë•Œ
   controllerì—ì„œ nullë¡œ ë°›ìŒ

   `List<Map<String,Object>>` : DTOë¥¼ ë§Œë“¤ì§€ ì•Šê³  ë°›ì„ ë•Œ
   mapperì—ì„œ ì „ë¶€ (?,?,?,...) ë¡œ ëœ¸ ê°’ì´ nullë¡œ ì „ë¶€ ì…ë ¥   

   ì—ëŸ¬ ì›ì¸:   

   <img src="../../imgs/project/api_array.png" style="border:3px solid black;border-radius:9px;width:700px">   
   <img src="../../imgs/project/api_json.png" style="border:3px solid black;border-radius:9px;width:700px">   
   
   ê°ì²´ì™€ ì œëŒ€ë¡œ ë§µí•‘ì´ ë˜ì§€ ì•ŠëŠ” í˜•íƒœ, "_text"ë¥¼ ì˜ë¼ì¤˜ì•¼ í•œë‹¤

   ```
      [{"NUM":{"_text":"1"},"DUTYADDR":{"_text":"ëŒ€ì „ê´‘ì—­ì‹œ ë™êµ¬ ê³„ì¡±ë¡œ 362, ì„±ë‚¨ì•½êµ­ 1ì¸µ (ì„±ë‚¨ë™)"},"DUTYETC":{"_text":"null"},"DUTYINF":{"_text":"null"},"DUTYMAPIMG":{"_text":"null"},"DUTYNAME":{"_text":"ì„±ë‚¨ì•½êµ­"},"DUTYTEL1":{"_text":"042-672-2957"},"DUTYTIME1C":{"_text":"1900"},"DUTYTIME2C":{"_text":"1900"},"DUTYTIME3C":{"_text":"1900"},"DUTYTIME4C":{"_text":"1900"},"DUTYTIME5C":{"_text":"1900"},"DUTYTIME6C":{"_text":"1300"},"DUTYTIME7C":{"_text":"null"},"DUTYTIME8C":{"_text":"null"},"DUTYTIME1S":{"_text":"0900"},"DUTYTIME2S":{"_text":"0900"},"DUTYTIME3S":{"_text":"0900"},"DUTYTIME4S":{"_text":"0900"},"DUTYTIME5S":{"_text":"0900"},"DUTYTIME6S":{"_text":"0900"},"DUTYTIME7S":{"_text":"null"},"DUTYTIME8S":{"_text":"null"},"HPID":{"_text":"C1601311"},"POSTCDN1":{"_text":"345"},"POSTCDN2":{"_text":"90 "},"LON":{"_text":"127.434066050389"},"LAT":{"_text":"36.3444243564852"},"X":{"_text":"14185895.342445694"},"Y":{"_text":"4348117.714357322"},"DUTYWEEKENDAT":{"_text":"N"}},{"NUM":{"_text":"2"}, ...
   ```
   1)_textë¥¼ ì°¾ì•„ì„œ ì• 2ê¸€ì, ë’¤ 2ê¸€ìë¥¼ ìë¥¸ë‹¤   
   2)ì‰¬í‘œ ì•ì— }ë¥¼ ìë¥¸ë‹¤   
   3)ë°ì´í„° ê°€ì¥ ë’¤ì— }ë¥¼ ìë¥¸ë‹¤

