---
layout: single
title: IPv4 조각화
categories: Network
tag: [조각화, MTU]
---

1. # 조각화란?
   전송하려는 페이로드가 MTU설정 값(일반적으로 1500byte) 보다 큰 경우 여러 개의 작은 패킷으로 조각화(쪼개어) 되어 전송됩니다. 라우터에서 설정한 MUT보다 패킷이 큰 경우 목적지까지 전달하는 과정에 통과하는 각 라우터마다 전송에 적합한 프레임으로 변환이 필요합니다. 일단 조각화되면, 최종 목적지에 도달할 때까지 재조립되지 않는 것이 일반적입니다.   
   IPv4에서는 발신지 뿐만 아니라 중간 라우터에서도 IP조각화가 가능합니다.   
   IPv6에서는 IP 단편화가 발신지에서만 가능합니다.   
   재조립은 항상 최종 수신지에서만 가능합니다.   
       
   <span color="red">*MTU:네트워크 장비 마다 설정된 최대 허용 패킷 크기</span>    

1. # 조각화 된 패킷
   ICMP프로토콜 - 8byte, IP프로토콜 - 20byte, ARP프로토콜 - 28byte.   
   
   예) 보낼 DATA가 2000byte. MTU가 1500byte 일 때 조각화 진행 과정.   

   조각화 전   
   ```
      | DATA | - 2000byte.

      | ICMP | DATA | - ICMP가 인캡슐화 되어서 총 2008byte가 됩니다. 
      (ICMP 대신 TCP가 붙을 수 있고, UDP가 붙을 수 있고,.. 예로 ICMP를 든 겁니다)   

      | IPv4 | ICMP | DATA | - 헤더로 IPv4가 인캡슐화 됩니다. IP는 20byte. 총 2028byte 패킷이 됩니다.   
      패킷은 총 2028byte. 전송 될 수 있는 최대크기 MTU는 1500byte. 패킷을 조각화하여 전송을 해야합니다.
   ```   

   조각화 하기   
   ```
   DATA 2000byte를 IP프로토콜 20byte가 붙을 것을 고려해 MTU최대 1500byte 이하 가장 큰 수로 1480byte와 나머지로 쪼갭니다

   | DATA1 | ->1480byte , | DATA2 | -> 520byte.

   | IPv4 | DATA1 | -> 20byte(IP)+1480byte=1500byte.

   | IPv4 | ICMP | DATA2 | -> 20byte(IP)+8byte(ICMP)+520byte=548byte.
   
   MTU(1500)----------------------------------------------------------------------
   
   | Eth | IPv4 | DATA1 | -> 14byte(Eth)+1500byte=1514byte  
   
   | Eth | IPv4 | ICMP | DATA2 | -> 14byte(Eth)+548byte=562byte   
   ```   
   <span style="color:red">*DATA1에는 ICMP가 붙지않고 뒤에 DATA2에만 ICMP가 붙었는데, 이는 ICMP프로토콜 자체가 IP프로토콜을 보안하기 위해 개발된 프로토콜이라서 쪼개진 각각의 페이로드에 대한 메시지가 아니라 IP에 대한 메시지를 전달하면 되기 때문이 아닌가 생각해봅니다.</span>   

   상위계층부터 3계층까지 데이터들의 값을 다 합친 후 MTU크기에 맞게 조각화를 합니다. 이후 마지막으로 Eth프로토콜을 패킷에 추가 합니다. 조각화 이후 Eth 추가.   

1. # 조각화 문제
   보내려는 데이터 크기 : 2379   
   MTU : 980   
   
   몇 개의 패킷으로 쪼개지는가?   
      
   첫번째 패킷의 데이터의 크기는 몇인가?   
      
   마지막 패킷의 데이터의 크기는 몇인가?   
      
   ------------------------------------------------------------   
   
   980에서 20(IP프로토콜 크기) 뺀다 960   
   
   2379 = 960 + 960 + 459   
   
   3개의 패킷   
      
   960    
      
   459   
   
